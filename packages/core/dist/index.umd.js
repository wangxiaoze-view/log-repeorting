((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("lz-string"),require("js-base64"),require("rrweb")):"function"==typeof define&&define.amd?define(["exports","lz-string","js-base64","rrweb"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).logReportingCore={},e.lz,e.jsBase64,e.RRweb)})(this,function(i,o,s,e){function t(r){var o=Object.create(null);return r&&Object.keys(r).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(r,e),Object.defineProperty(o,e,t.get?t:{enumerable:!0,get:function(){return r[e]}}))}),o.default=r,Object.freeze(o)}var r=t(e);let c="undefined"!=typeof window?window:{},p=(c.__log_reporting__=c.__log_reporting__||{},c.__log_reporting__),n=console.log;let l=new class{constructor(){}log(e,t){n(`%c${e}%c `+t,"color: #fff;font-weight: blod;letter-spacing:2px;padding: 3px 5px;background-color: #73767a;border-radius: 3px;","color: #909399;font-weight: blod;letter-spacing:2px;padding: 3px 5px;")}info(e,t){n(`%c${e}%c `+t,"color: #fff;font-weight: blod;letter-spacing:2px;padding: 3px 5px;background-color: #337ecc;border-radius: 3px;","color: #409EFF;font-weight: blod;letter-spacing:2px;padding: 3px 5px;")}warn(e,t){n(`%c${e}%c `+t,"color: #fff;font-weight: blod;letter-spacing:2px;padding: 3px 5px;background-color: #b88230;border-radius: 3px;","color: #E6A23C;font-weight: blod;letter-spacing:2px;padding: 3px 5px;")}error(e,t){n(`%c${e}%c `+t,"color: #fff;font-weight: blod;letter-spacing:2px;padding: 3px 5px;background-color: #c45656;border-radius: 3px;","color: #F56C6C;font-weight: blod;letter-spacing:2px;padding: 3px 5px;")}success(e,t){n(`%c${e}%c `+t,"color: #fff;font-weight: blod;letter-spacing:2px;padding: 3px 5px;background-color: #529b2e;border-radius: 3px;","color: #67C23A;font-weight: blod;letter-spacing:2px;padding: 3px 5px;")}};function a(e,t){return Object.prototype.hasOwnProperty.call(t,e)}function u(e,t,r,o=!1){e.addEventListener(t,r,o)}function d(e){var t,r,o={};for([t,r]of new URLSearchParams(e).entries())o[t]=r;return o}l.log,l,l,l,l;class g{constructor(e){this.options=e}}let f;i.EVENT_TYPES=void 0,(e=i.EVENT_TYPES||(i.EVENT_TYPES={})).ERROR="error",e.UNHANDLEDREJECTION="unhandledrejection",e.CONSOLE_ERROR="consoleError",e.XHR="xhr",e.FETCH="fetch",e.PV="pv",e.EXPOSURE="exposure",i.ERROR_TYPES=void 0,(e=i.ERROR_TYPES||(i.ERROR_TYPES={})).JS="js_error",e.PROMISE="promise_error",e.CONSOLE_ERROR="console_error",e.XHR="xhr_error",e.FETCH="fetch_error";let h=p.eventBus||(p.eventBus=class Y{constructor(){this._eventMap=new Map}static getInstance(){return this._instance||(this._instance=new Y),this._instance}on(e,t){this._eventMap.has(e)||this._eventMap.set(e,[]),null!=(e=this._eventMap.get(e))&&e.push(t)}emit(e,...t){this._eventMap.has(e)&&null!=(e=this._eventMap.get(e))&&e.forEach(e=>{e(...t)})}off(r,o){var e;this._eventMap.has(r)&&null!=(e=this._eventMap.get(r))&&e.forEach((e,t)=>{e===o&&null!=(e=this._eventMap.get(r))&&e.splice(t,1)})}once(r,o){var e;this._eventMap.has(r)&&null!=(e=this._eventMap.get(r))&&e.forEach((e,t)=>{e===o&&null!=(e=this._eventMap.get(r))&&e.splice(t,1)})}}.getInstance());function E(e){return e in navigator?navigator[e]:"该浏览器不支持!"}function b(e,t){var e=JSON.stringify(e),r=p.baseInfo.options.encryptMethod;return"lz"===r?o.compress(e):s.Base64.encode(e)}function m(e,t){e={appId:p.baseInfo.options.appId,baseInfo:Object.assign({title:document.title,url:location.href,date:Date.now()},{platform:E("platform"),appName:E("appName"),appVersion:E("appVersion"),appCodeName:E("appCodeName"),vendor:E("vendor"),userAgent:E("userAgent"),onLine:E("onLine"),language:E("language"),product:E("product"),productSub:E("productSub"),windowWidth:window.screen.width,windowHeight:window.screen.height,colorDepth:window.screen.colorDepth}),reportInfo:Object.assign({eventId:e,snapshot:b(p.record.snapshot)},t)};let n=p.baseInfo.options.dsn,a=null!=(t=p.baseInfo.options.method)?t:"beacon",i=JSON.stringify(e);new Promise(e=>{switch(a){case"beacon":t=n,s=i,new Promise(e=>{navigator.sendBeacon(t,s),e(!0)}).then(()=>{e({type:"xhr",success:!0})});break;case"xhr":r=n,o=i,new Promise(e=>{let t=new XMLHttpRequest;t.open("post",r,!0),t.setRequestHeader("Content-Type","application/json"),t.send(o),e(!0),t.onreadystatechange=function(){4===t.readyState&&e(!0)}}).then(()=>{e({type:"xhr",success:!0})});break;default:l.warn("上报方式不支持:","上报方式只支持 'beacon' 和 'xhr'")}var r,o,t,s})}function v(){for(var e in i.EVENT_TYPES)if(a(e,i.EVENT_TYPES)){r=t=void 0;var t=e;if(a(t,i.EVENT_TYPES)){var r=i.EVENT_TYPES[t];switch(r){case i.EVENT_TYPES.ERROR:(t=>{h.on(t,e=>{p.baseInfo.options.isDebug&&l.error("js逻辑错误：",JSON.stringify(e)),m(t,e)})})(r);break;case i.EVENT_TYPES.CONSOLE_ERROR:(t=>{h.on(t,e=>{p.baseInfo.options.isDebug&&l.info("console错误：",JSON.stringify(e)),m(t,e)})})(r);break;case i.EVENT_TYPES.UNHANDLEDREJECTION:(t=>{h.on(t,e=>{p.baseInfo.options.isDebug&&l.error("Promise错误：",JSON.stringify(e)),m(t,e)})})(r);break;case i.EVENT_TYPES.XHR:(t=>{"XMLHttpRequest"in c&&h.on(t,e=>{p.baseInfo.options.isDebug&&l.error("xhr接口错误：",JSON.stringify(e)),m(t,e)})})(r);break;case i.EVENT_TYPES.FETCH:(t=>{"fetch"in c&&h.on(t,e=>{p.baseInfo.options.isDebug&&l.error("fetch接口错误：",JSON.stringify(e)),m(t,e)})})(r)}}}}let _;function T(e,t=1){return(e||"").split("\n").slice(t).map(e=>e.replace(/^\s+at\s+/g,"")).join("~~")}function O(e){var t={errorMessage:"",time:Date.now(),colno:0,lineno:0,stackMessage:"",fileName:""};try{var r,o,s,n,a=/http[s]?:\/\/[^:]+(:\d+)?\/([^:]+):(\d+):(\d+)/,i=T(e.stack).split("~~")[1];return i?(r=i.match(a))?(o=r[2],s=parseInt(r[3],10),n=parseInt(r[4],10),{errorMessage:e.message,time:Date.now(),colno:n,lineno:s,stackMessage:T(e.stack),fileName:o}):t:t}catch(e){return t}}function y(e){var t,e=e||_;let r={};return r=e?{pointerId:e.pointerId,pointerType:e.pointerType,timeStamp:e.timeStamp,type:e.type,layerX:e.x,layerY:e.y,nodeName:null!=(t=e.nodeName)?t:e.target.nodeName,nodeType:null!=(t=e.nodeType)?t:e.target.nodeType,textContent:null!=(t=e.textContent)?t:e.target.textContent,className:null!=(t=e.className)?t:e.target.className,elId:null!=(t=e.id)?t:e.target.id}:r}function w(e){var t=O(e);let r;return r=t.stackMessage?t:{errorMessage:e.error?e.error.message:"",stackMessage:T(null==(t=e.error)?void 0:t.stack),lineno:e.lineno,colno:e.colno,fileName:e.filename,time:Date.now()},Object.assign(Object.assign({bubbles:e.bubbles,eventType:e.type,isTrusted:e.isTrusted},r),{time:Date.now(),timeStamp:Math.round(e.timeStamp),el:y()})}function R(e,t){return Object.assign(Object.assign({},w(e)),{questOptions:t})}function S(e,t={}){return Object.assign({questOptions:e,el:y()},t)}function N(){for(var e in i.EVENT_TYPES)if(a(e,i.EVENT_TYPES)){r=t=void 0;var t=e;if(a(t,i.EVENT_TYPES)){var r=i.EVENT_TYPES[t];switch(r){case i.EVENT_TYPES.ERROR:(t=>{p.baseInfo.options.isError&&u(c,t,e=>h.emit(t,Object.assign({errorType:i.ERROR_TYPES.JS},w(e))),!0)})(r);break;case i.EVENT_TYPES.CONSOLE_ERROR:(o=>{if(p.baseInfo.options.isConsoleError){let r=console.error;console.error=function(...e){var t=e.map(e=>"string"==typeof e?e:JSON.stringify(e)).join(" "),t=new Error(t);h.emit(o,Object.assign({errorType:i.ERROR_TYPES.CONSOLE_ERROR},O(t))),r.apply(console,e)}}})(r);break;case i.EVENT_TYPES.UNHANDLEDREJECTION:(t=>{p.baseInfo.options.isError&&u(c,t,e=>h.emit(t,Object.assign({errorType:i.ERROR_TYPES.PROMISE},(e=>{let t,r,o=0,s=0,n="";var a,i=e.reason;return"string"==typeof i?t=i:"object"==typeof i&&(t=i.message,i.stack&&(a=i.stack.match(/at\s+(.+):(\d+):(\d+)/),r=a[1],s=a[2],o=a[3]),n=T(i.stack)),Object.assign(Object.assign({},w(e)),{errorMessage:t,stackMessage:n,fileName:r,lineno:Number(s),colno:Number(o)})})(e))))})(r);break;case i.EVENT_TYPES.XHR:(a=>{if(p.baseInfo.options.isXhr&&"XMLHttpRequest"in c){let s={},n=XMLHttpRequest.prototype.send,r=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t){return s.method=e,s.url=t,r.call(this,e,t,!0)},XMLHttpRequest.prototype.send=function(e){var t;["get","delete"].includes(s.method.toLowerCase())&&s.url&&-1!==s.url.indexOf("?")&&(t=null==(t=s.url)?void 0:t.substring(s.url.indexOf("?")+1),s.params=d(t));let r=()=>({method:s.method.toLowerCase(),url:s.url||"",status:this.status,params:"string"==typeof(e||s.params)?e||s.params:JSON.stringify(e||s.params),message:this.statusText}),o={errorType:i.ERROR_TYPES.XHR};return this.addEventListener("readystatechange",e=>{4===this.readyState&&(this.status<200||300<=this.status)&&h.emit(a,Object.assign(Object.assign({},o),R(e,r())))}),this.addEventListener("error",e=>{h.emit(a,Object.assign(Object.assign({},o),R(e,r())))},!1),this.addEventListener("abort",e=>{h.emit(a,Object.assign(Object.assign({},o),R(e,r())))},!1),n.call(this,e)}}})(r);break;case i.EVENT_TYPES.FETCH:(a=>{if(p.baseInfo.options.isXhr&&"fetch"in c){let o=c.fetch,s={},n={errorType:i.ERROR_TYPES.FETCH};c.fetch=function(e,t={}){var{method:r="GET"}=t||{method:"GET"},r=(s.method=r.toLowerCase(),s.url=e.toString(),["get","delete"].includes(s.method.toLowerCase())&&s.url&&(r=null==(r=s.url)?void 0:r.substring(s.url.indexOf("?")+1),s.params=d(r)),["post","put"].includes(s.method.toLowerCase())&&(s.params=JSON.stringify(t.body||{})),o(e,t));return r.then(t=>{(t.status<200||300<=t.status)&&t.text().then(()=>{var e={method:s.method.toLowerCase(),url:s.url||"",status:t.status,params:s.params||{},message:t.statusText};h.emit(a,Object.assign(Object.assign({},n),S(e)))})},e=>{var t={method:s.method.toLowerCase(),url:s.url||"",status:500,params:s.params||{},message:"请求失败"};h.emit(a,Object.assign(Object.assign({},n),S(t,O(e))))}),r}}})(r)}}}}["click","touchstart","mousedown","keydown","mouseover"].forEach(e=>{document.addEventListener(e,e=>{_=e},{capture:!0,passive:!0})});class x{constructor(e){this.data=e}}let P;class M{constructor(e){this.data=e}}let I;function j(){var e=new PerformanceObserver(()=>{}),e=(e.observe({type:"navigation",buffered:!0}),e.observe({type:"resource",buffered:!0}),e.takeRecords()),t=e.find(e=>"navigation"===e.entryType),r=(t&&(t=(e=>{var{domainLookupEnd:e,domainLookupStart:t,connectEnd:r,connectStart:o,secureConnectionStart:s,responseStart:n,requestStart:a,domInteractive:i,domComplete:c,loadEventEnd:p,loadEventStart:l,fetchStart:u}=e;return{dns:e-t,tcp:r-o,ssl:s,ttfb:n-a,render:null!=i?i:0,dom:null!=c?c:0,load:(null!=p?p:0)-(null!=l?l:0),total:(null!=p?p:0)-(null!=u?u:0)}})(t),null!=(r=null==(r=p.baseInfo)?void 0:r.options))&&r.isPerformance&&(P=new x(t),p.performance=P),e.filter(e=>"resource"===e.entryType));t=r,null!=(e=null==(e=p.baseInfo)?void 0:e.options)&&e.isResource&&(I=new M(t),p.reource=I)}class L{constructor(){this.snapshot=[],this.init()}init(){var e=null!=(e=p.baseInfo.options.record.time)?e:1e4;this.closeCallback=r.record({emit:(e,t)=>{t&&(this.snapshot=[]),this.snapshot.push(e)},recordCanvas:!0,checkoutEveryNms:6e4<=e?6e4:e,sampling:{mousemove:!0,scroll:150,media:800,input:"last",mouseInteraction:{MouseUp:!1,MouseDown:!1,Click:!1,ContextMenu:!1,DblClick:!1,Focus:!1,Blur:!1,TouchStart:!1,TouchEnd:!1}}})}close(){var e;null!=(e=this.closeCallback)&&e.call(this),this.closeCallback=void 0}}let C;class V{constructor(){this.options={root:null,rootMargin:"0px",threshold:.5},this.observerMap=new WeakMap,this.targetMap=[]}init(t){return new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&m(i.EVENT_TYPES.EXPOSURE,{time:Date.now(),threshold:t.threshold,message:t.message,el:y(t.target),snapshot:[]})})},Object.assign(Object.assign({},this.options),{threshold:t.threshold||.5}))}observer(e){(Array.isArray(e)?e:[e]).forEach(r=>{var e=Array.isArray(r.target)?r.target:[r.target];this.observerMap.has(r)||this.observerMap.set(r,this.init(r)),e.forEach(t=>{var e;this.targetMap.find(e=>e.target===t)||(null!=(e=this.observerMap.get(r))&&e.observe(r.target),this.targetMap.push(r))})})}unobserver(e){(Array.isArray(e)?e:[e]).forEach(t=>{var e,r=this.targetMap.find(e=>e.target===t),o=this.targetMap.findIndex(e=>e.target===t);r&&this.observerMap.get(r)&&(null!=(e=this.observerMap.get(r))&&e.unobserve(t),this.observerMap.delete(r),this.targetMap.slice(o,1))})}}let k;class D{constructor(){}init(e){c.__log_reporting_init__||(e=>{if(e.dsn&&"string"==typeof e.dsn)return 1;l.error("dsn参数错误","dsn地址应该为 [字符串], 例如: https://www.wangxiaoze.wang")})(e)&&(e=e,f=new g(e),p.baseInfo=f,j(),N(),v(),p.baseInfo.options.isPv&&h.on(i.EVENT_TYPES.PV,e=>{m(i.EVENT_TYPES.PV,Object.assign(Object.assign({},e),{snapshot:[]}))}),p.baseInfo.options.isExposure&&(k=new V,p.exposure=k),p.baseInfo.options.record&&p.baseInfo.options.record.open&&(C=new L,p.record=C),c.__log_reporting_init__=!0)}}let H={dsn:"",isDebug:!1,isError:!0,isConsoleError:!1,isPerformance:!0,isResource:!1,isXhr:!0,record:{open:!0,time:1e4},encryptMethod:"lz",method:"beacon",isPv:!1};var e="@log-reporting/core",X="1.0.5",J="王小泽 <wangze@anbangke.com>",q="前端日志上报SDK";let A;i._author=J,i._description=q,i._global=c,i._name=e,i._support=p,i._version=X,i.decryptionFun=function(e,t){var r=p.baseInfo.options.encryptMethod;return"lz"===r?o.decompress(e):s.Base64.decode(e)},i.encryptFun=b,i.init=(e=H)=>{(A=new D).init(e)},i.lestenExposure=function(e){if(p.baseInfo.options.isExposure)try{k.observer(e)}catch(e){p.baseInfo.options.isDebug&&l.error("曝光Api报错",e.message||"")}},i.lestenPv=function(e){p.baseInfo.options.isPv&&h.emit(i.EVENT_TYPES.PV,e)}});
